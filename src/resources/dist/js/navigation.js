$(".btn-migrate").on("click",(function(e){e.preventDefault(),$('input[name="action"]').val($(this).data("action")),$("#main-form").submit()})),void 0===Craft.Navigation&&(Craft.Navigation={}),function(e){function t(t){var i="";e.each(t,(function(e,t){var n=t.disabled?"disabled":"";i+='<option value="'+t.value+'" '+n+">"+t.label+"</option>"})),e('select[name="parent"]').each((function(t,n){var s=e(n).val();e(n).html(i),e(n).val(s)}))}Craft.Navigation=Garnish.Base.extend({nav:null,siteId:null,structure:null,structureElements:{},elementType:null,elementModals:[],$builderContainer:e(".js-nav-builder"),$structureContainer:e(".js-nav-builder .structure"),$emptyContainer:e(".js-navigation-empty"),$addElementButton:e(".js-btn-element-add"),$addElementLoader:e(".nav-content-pane .buttons .spinner"),$manualForm:e("#manual-form"),$manualLoader:e("#manual-form .spinner"),$nodeTypeForm:e(".node-type-form"),$nodeTypeLoader:e(".node-type-form .spinner"),$template:e("#js-node-template").html(),init:function(t,i){this.nav=t,this.siteId=i.siteId,new Craft.Navigation.Accordion,this.structure=this.$structureContainer.data("structure");for(var n=this.$structureContainer.find("li"),s=0;s<n.length;s++){var a=e(n[s]),d=a.find(".element").data("id");this.structureElements[d]=new Craft.Navigation.StructureElement(this,a)}this.addListener(this.$addElementButton,"activate","showModal"),this.addListener(this.$manualForm,"submit","onManualSubmit"),this.addListener(this.$nodeTypeForm,"submit","onNodeTypeSubmit")},showModal:function(t){this.elementType=e(t.currentTarget).data("element-type"),this.elementModals[this.elementType]?this.elementModals[this.elementType].show():this.elementModals[this.elementType]=this.createModal(this.elementType)},createModal:function(t){return Craft.createElementSelectorModal(t,{criteria:{enabledForSite:null},sources:"*",multiSelect:!0,onSelect:e.proxy(this,"onModalSelect")})},onModalSelect:function(t){for(var i=e('.accordion-list-item[data-element-type="'+this.elementType.replace(/\\/gi,"\\\\")+'"]'),n=i.find(".js-parent-node select").val(),s=i.find("#newWindow-field input").val(),a=0;a<t.length;a++){var d=t[a];this.elementModals[this.elementType].$body.find('tr[data-id="'+d.id+'"]').removeClass("sel");var r={navId:this.nav.id,siteId:this.siteId,elementId:d.id,elementSiteId:d.siteId,title:d.label,url:d.url,type:this.elementType,newWindow:s,parentId:n};this.saveNode(r)}},onManualSubmit:function(e){e.preventDefault();var t=this.$manualForm.find(".js-parent-node select").val(),i=this.$manualForm.find("#newWindow-field input").val(),n={navId:this.nav.id,siteId:this.siteId,title:this.$manualForm.find("#title").val(),url:this.$manualForm.find("#url").val(),newWindow:i,parentId:t};this.saveNode(n)},onNodeTypeSubmit:function(e){e.preventDefault();var t=this.$nodeTypeForm.find(".js-parent-node select").val(),i=this.$nodeTypeForm.find("#newWindow-field input").val(),n=this.$nodeTypeForm.parents("[data-node-type]").data("node-type"),s={navId:this.nav.id,siteId:this.siteId,title:this.$nodeTypeForm.find("#title").val(),url:this.$nodeTypeForm.find("#url").val(),newWindow:i,parentId:t,type:n};this.saveNode(s)},addNode:function(t,i){var n="manual",s;t.type&&(n=t.type.split("\\").pop());var a=this.$template.replace(/__siteId__/gi,t.siteId?t.siteId:"").replace(/__status__/gi,t.enabled?"enabled":"disabled").replace(/__title__/gi,t.title).replace(/__id__/gi,t.id).replace(/__url__/gi,t.url).replace(/__type__/gi,n).replace(/__level__/gi,i),d=e(a),r=e(this.structure.$container).attr("id");e("#"+r).length||e(this.structure.$container).appendTo(this.$builderContainer);var o=this.structure.$container;if(t.newParentId>0){var l=this.structure.$container.find('.element[data-id="'+t.newParentId+'"]').closest("li"),h=l.find("> ul"),u=l.data("level");h.length||(h=e("<ul/>")).appendTo(l),o=h}return d.appendTo(o),this.structure.structureDrag.addItems(d),d.css("margin-bottom",-30),d.velocity({"margin-bottom":0},"fast"),d},saveNode:function(i){this.$manualLoader.removeClass("hidden"),this.$addElementLoader.removeClass("hidden"),Craft.postActionRequest("navigation/nodes/save-node",i,e.proxy((function(e,i){if(this.$manualLoader.addClass("hidden"),this.$addElementLoader.addClass("hidden"),e.success){this.$manualForm.find("#title").val(""),this.$manualForm.find("#url").val("");var n=e.node.id,s=this.addNode(e.node,e.level);this.structureElements[n]=new Craft.Navigation.StructureElement(this,s),this.$emptyContainer.addClass("hidden"),t(e.parentOptions),Craft.cp.displayNotice(Craft.t("navigation","Node added."))}else Craft.cp.displayError(e.message)}),this))}}),Craft.Navigation.StructureElement=Garnish.Base.extend({container:null,structure:null,$node:null,$elements:null,$element:null,$settingsBtn:null,$deleteBtn:null,init:function(t,i){this.container=t,this.structure=t.structure,this.$node=i,this.$element=i.find(".element:first"),this.$settingsBtn=this.$node.find(".settings:first"),this.$deleteBtn=this.$node.find(".delete:first"),this.structure.structureDrag.settings.onDragStop=e.proxy(this,"onDragStop"),this.addListener(this.$settingsBtn,"click","showSettings"),this.addListener(this.$element,"dblclick","showSettings"),this.addListener(this.$deleteBtn,"click","removeNode")},onDragStop:function(){var i,n,s,a={nodeId:this.$element.data("id"),siteId:this.$element.data("site-id"),navId:this.container.nav.id};setTimeout((function(){Craft.postActionRequest("navigation/nodes/move",a,e.proxy((function(e,i){e.success&&t(e.parentOptions)}),this))}),500)},showSettings:function(){new Craft.Navigation.Editor(this.$element)},removeNode:function(){for(var i=[],n=this.$node.find(".element"),s=this.$element.data("site-id"),a=this.container.nav.id,d=0;d<n.length;d++)i[d]=e(n[d]).data("id");var r;if(confirm(Craft.t("navigation","Are you sure you want to delete “{title}” and its descendants?",{title:this.$element.data("label")}))){var o={nodeIds:i,navId:a,siteId:s};Craft.postActionRequest("navigation/nodes/delete",o,e.proxy((function(i,s){i.success?(Craft.cp.displayNotice(Craft.t("navigation","Node deleted.")),t(i.parentOptions),n.each(e.proxy((function(t,i){this.structure.removeElement(e(i)),delete this.container.structureElements[e(i).data("id")]}),this)),0==Object.keys(this.container.structureElements).length&&this.container.$emptyContainer.removeClass("hidden")):Craft.cp.displayError(i.errors)}),this))}}}),Craft.Navigation.Editor=Garnish.Base.extend({$node:null,nodeId:null,siteId:null,$form:null,$fieldsContainer:null,$cancelBtn:null,$saveBtn:null,$spinner:null,hud:null,init:function(t){this.$node=t,this.nodeId=t.data("id"),this.siteId=t.data("site-id"),this.$node.addClass("loading");var i={nodeId:this.nodeId,siteId:this.siteId};Craft.postActionRequest("navigation/nodes/editor",i,e.proxy(this,"showEditor"))},showEditor:function(t,i){if(t.success){this.$node.removeClass("loading");var n=e();this.$form=e("<form/>"),e('<input type="hidden" name="nodeId" value="'+this.nodeId+'">').appendTo(this.$form),e('<input type="hidden" name="siteId" value="'+this.siteId+'">').appendTo(this.$form),this.$fieldsContainer=e('<div class="fields"/>').appendTo(this.$form),this.$fieldsContainer.html(t.html),Garnish.requestAnimationFrame(e.proxy((function(){Craft.appendHeadHtml(t.headHtml),Craft.appendFootHtml(t.footHtml),Craft.initUiElements(this.$fieldsContainer)}),this));var s=e('<div class="hud-footer"/>').appendTo(this.$form),a=e('<div class="buttons right"/>').appendTo(s);this.$cancelBtn=e('<div class="btn">'+Craft.t("app","Cancel")+"</div>").appendTo(a),this.$saveBtn=e('<input class="btn submit" type="submit" value="'+Craft.t("app","Save")+'"/>').appendTo(a),this.$spinner=e('<div class="spinner left hidden"/>').appendTo(a),n=n.add(this.$form),this.hud=new Garnish.HUD(this.$node,n,{bodyClass:"body nav-editor-hud",closeOtherHUDs:!1}),this.hud.on("hide",e.proxy((function(){this.hud.$body.remove(),delete this.hud}),this)),this.initEventListeners(),this.addListener(this.$saveBtn,"click","saveNode"),this.addListener(this.$cancelBtn,"click","closeHud")}},initEventListeners:function(){Garnish.requestAnimationFrame(e.proxy((function(){var t=this.$fieldsContainer.find(".elementselect"),i;t&&(t.data("elementSelect").settings.onSelectElements=e.proxy(this,"onSelectElements"))}),this)),this.$typeSelect=this.$fieldsContainer.find("#type-field #type"),this.$typeSpinner=e('<div class="spinner hidden"></div>').appendTo(this.$typeSelect.parent().parent()),this.addListener(this.$typeSelect,"change","onSelectType")},onSelectElements:function(e){var t=e[0].siteId,i=e[0].url;this.$fieldsContainer.find('input[name="elementSiteId"]').val(t),this.$fieldsContainer.find('input[name="url"]').val(i)},onSelectType:function(t){t.preventDefault(),this.$typeSpinner.removeClass("hidden");var i=this.$form.serialize();Craft.postActionRequest("navigation/nodes/change-node-type",i,e.proxy((function(t,i){this.$typeSpinner.addClass("hidden"),this.$fieldsContainer.html(t.html),Garnish.requestAnimationFrame(e.proxy((function(){Craft.appendHeadHtml(t.headHtml),Craft.appendFootHtml(t.footHtml),Craft.initUiElements(this.$fieldsContainer)}),this)),this.initEventListeners()}),this))},saveNode:function(i){i.preventDefault(),this.$spinner.removeClass("hidden");var n=this.$form.serialize(),s=this.$node.parent().find(".status"),a=this.$node.find(".target");Craft.postActionRequest("navigation/nodes/save-node",n,e.proxy((function(e,i){this.$spinner.addClass("hidden"),e.success?(Craft.cp.displayNotice(Craft.t("navigation","Node updated.")),t(e.parentOptions),this.$node.parent().data("label",e.node.title),this.$node.parent().find(".title").text(e.node.title),e.node.enabled&&e.node.enabledForSite?(s.addClass("enabled"),s.removeClass("disabled")):(s.addClass("disabled"),s.removeClass("enabled")),this.closeHud()):(Garnish.shake(this.hud.$hud),Craft.cp.displayError(e.errors))}),this))},closeHud:function(){this.hud.hide()}}),Craft.Navigation.Accordion=Garnish.Base.extend({init:function(){var t,i,n,s;if(this.$tabsList=this.$tabs=this.$selectedTab=this.selectedTabIndex=null,this.$tabsContainer=e("#accordion"),this.$tabsContainer.length)for(this.$tabsList=this.$tabsContainer.find("> ul"),this.$tabs=this.$tabsList.find("> li"),t=0;t<this.$tabs.length;t++)(s=(n=(i=this.$tabs.eq(t)).children("a")).attr("href"))&&"#"===s.charAt(0)&&(this.addListener(n,"click",(function(e){e.preventDefault(),this.selectTab(e.currentTarget)})),encodeURIComponent(s.substr(1))===document.location.hash.substr(1)&&this.selectTab(n)),!this.$selectedTab&&n.hasClass("sel")&&this._selectTab(n,t);else this.$tabsContainer=null},selectTab:function(t){var i=e(t);if(this.$selectedTab){if(this.$selectedTab.get(0)===i.get(0))return;this.deselectTab()}i.addClass("sel");var n=i.attr("href");e(n).removeClass("hidden"),"undefined"!=typeof history&&history.replaceState(void 0,void 0,n),this._selectTab(i,this.$tabs.index(i.parent())),this.updateTabs(),Garnish.$doc.trigger("scroll")},_selectTab:function(e,t){this.$selectedTab=e,this.selectedTabIndex=t},deselectTab:function(){this.$selectedTab&&(this.$selectedTab.removeClass("sel"),"#"===this.$selectedTab.attr("href").charAt(0)&&e(this.$selectedTab.attr("href")).addClass("hidden"),this._selectTab(null,null))},handleWindowResize:function(){this.updateTabs()},updateTabs:function(){if(this.$tabsContainer){var e=Math.floor(this.$tabsContainer.width())-40,t=0,i=Garnish.$bod.width()>=768?-12:-7,n;this.$selectedTab&&(this.$selectedTab.parent("li").appendTo(this.$tabsList),t=Math.ceil(this.$selectedTab.parent("li").width()));for(var s=0;s<this.$tabs.length;s++)n=this.$tabs.eq(s).appendTo(this.$tabsList),s!==this.selectedTabIndex&&(t+=Math.ceil(n.width()),(0!==s||this.$selectedTab)&&(t+=i)),(s===this.selectedTabIndex||t<=e)&&n.find("> a").removeAttr("role")}}})}(jQuery);
//# sourceMappingURL=navigation.js.map